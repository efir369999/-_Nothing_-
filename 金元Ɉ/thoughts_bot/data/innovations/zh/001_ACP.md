# ACP — 基于存在的共识

**实现:** `montana/src/consensus.rs`
**版本:** 1.0

---

## 核心

```rust
// consensus.rs:7-14
// 比特币问: "你做了多少工作?" (PoW)
// 以太坊问: "你质押了多少?" (PoS)
// Montana问: "你在这里吗?"
//
// 80% — 服务器 (Full Node) — 基础设施
// 20% — 人类 (Verified User) — 去中心化
//
// lim(evidence → ∞) 1 Ɉ → 1 秒
```

---

## 架构 (80/20)

| 节点类型 | 份额 | 间隔 | 要求 |
|----------|------|------|------|
| Full Node | 80% | τ₁ (1分钟) | 自动签名 |
| Verified User | 20% | 10-40分钟 | 生物识别 + FIDO2 |

**来自代码:**
```rust
pub const FULL_NODE_CAP_PERCENT: u64 = 80;
pub const VERIFIED_USER_CAP_PERCENT: u64 = 20;
```

---

## 存在证明

Full Node 每个 τ₁ 签名:
```rust
// consensus.rs:177-190
msg.extend_from_slice(b"MONTANA_PRESENCE_V1:");
msg.extend_from_slice(&timestamp.to_le_bytes());
msg.extend_from_slice(prev_slice_hash);
msg.extend_from_slice(pubkey);
msg.extend_from_slice(&tau2_index.to_le_bytes());
```

---

## 抽签

区块生产者选择 — 确定性:
```rust
// consensus.rs:527-533
// 正确:  seed = SHA3(prev_slice_hash ‖ τ₂_index)
// 错误:  seed = SHA3(prev_slice_hash ‖ τ₂_index ‖ presence_root)
//                                                    ^^^^^^^^^^^^^^
//                                                    区块生产者控制这个!
```

---

## FIDO2/WebAuthn

Verified User 需要生物识别证明:
```rust
// consensus.rs:382-389
// User Present (UP) 标志必须设置
if flags & 0x01 == 0 {
    return Err(PresenceError::Fido2UserNotPresent);
}
// User Verified (UV) 标志必须设置 (生物识别)
if flags & 0x04 == 0 {
    return Err(PresenceError::Fido2UserNotVerified);
}
```

---

## 防护

| 攻击 | 防御 |
|------|------|
| 女巫攻击 | 生物识别 + 安全芯片 |
| 机器人 | 随机间隔 (10-40分钟) |
| 研磨攻击 | 种子在区块之前 |
| 日蚀攻击 | 80/20 层级上限 |

---

```
Alejandro Montana
2026年1月
```
